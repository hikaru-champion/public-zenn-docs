---
title: "kms"
emoji: "⛳"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: []
published: false
---

# Cloud KMSとは
Cloud KMS (Key Management Service)とは、Google Cloudが提供している鍵管理サービスです。
暗号鍵の作成や、使用、ローテーションなどを管理することができます。

# デフォルトの保存データの暗号化
Google Cloudでは、**デフォルトの保存データの暗号化**が行われており、Compute EngineのDiskやCloud Storageのデータは
Googleによって自動的に暗号化ライブラリである**Tink**を利用してAES-256で暗号化されています。
また、FIPS 140-2レベル1に準拠していることが検証された暗号モジュールが使用されます。
暗号化で使用される鍵はGoogleが所有し、管理しており、鍵の表示や管理、鍵の使用状況ログの確認はできません。
ユーザ独自で暗号化に使用する鍵を管理したい場合は、Cloud KMSの顧客管理の暗号鍵(CMEK)を利用することで、実現できます。

デフォルトの保存データの暗号化の詳細な記載は、公式ドキュメントに記載がありますので、ご確認ください。
https://cloud.google.com/docs/security/encryption/default-encryption?hl=ja

# 顧客管理の暗号鍵(CMEK)
顧客管理の暗号鍵(CMEK)とは、Googleではなく、ユーザが所有・管理する暗号鍵です。CMEKもデフォルトの保存データの暗号化と同様に
Compute EngineのDiskやCloud Storageのデータを暗号化する際に利用することができます。


# Cloud KMS基本概念
## キーリング
キーリングとは、特定のリージョン・マルチリージョン単位で鍵を管理するグループです。
キーリングの中に、鍵を作成し管理していきます。Google Cloudリソースである、Cloud StorageやBigQueryで鍵を利用したい場合は
ローケーション（リージョン・マルチリージョン）を一致させる必要があります。キーリングは一度作成すると削除することができないので、
キーリングを作成するローケーションは慎重に選ぶ必要があります。
費用については、鍵自体には費用が発生しますが、キーリング自体の費用は発生しません。

## キー
キーリング内に作成される暗号鍵のことを言います。鍵はバージョンとメタデータを含みます。

## 鍵のバージョン管理
また、鍵のバージョンには以下のステータスがあります。
- 生成を保留中（PENDING_GENERATION）
    - 非対称鍵のみに適用され、鍵が生成中の状態。使用準備が完了すると有効に遷移する。
- インポート保留中（PENDING_IMPORT）
    - インポートされた鍵にのみ適用され、鍵がインポート中の状態。使用準備が完了すると有効に遷移する。
- 有効（ENABLED）
    - 鍵バージョンは使用可能な状態
- 無効（DISABLED）
    - 鍵バージョンは使用できないが、鍵マテリアルは使用可能な状態でバージョンを有効化に戻すことも可能。
- 破棄の予定（DESTROY_SCHEDULED）
    - 鍵バージョンの破棄がスケジュールされており、スケジュールされた日数後破棄される。無効化に戻すことが可能
- 破棄（DESTROYED）
    - 鍵バージョンは破棄されており、鍵マテリアルもCloud KMS上に残っていない状態。破棄状態になった鍵バージョンはほかの状態にすることはできない。
- インポートに失敗しました（IMPORT_FAILED）
    - 鍵バージョンのインポートに失敗した状態。

:::alert
たとえ、鍵のステータスを「無効」、「破棄の予定」に変更しても「破棄」された鍵以外は、**費用**が発生するので注意が必要です。
:::

対称暗号化を利用している場合は、データの暗号化は**有効になっているメインの鍵バージョン**で行う必要があります。
メインの鍵バージョンが無効になっている場合は、その鍵を利用してデータを暗号化することはできず、
データの復号化に関しては、メインであるかどうかは影響せず、鍵バージョンが有効化であれば復号に利用することができます。
非対称暗号化、デジタル署名の場合は、鍵のステータスが有効かつ、鍵バージョンを指定して利用する必要があります。

## 鍵のローテーション
**対称暗号化のみ**鍵の自動ローテーションがサポートされています。
PCI DSS等に準拠する場合は、鍵の定期的な自動ローテーションが必要になるので、対応する必要があります。
自動ローテーションの期間は
- 30日
- 90日
- 180日
- 365日
- 実行しない（手動ローテーション）
- カスタム
から選択することができます。

非対称鍵に関しては鍵の自動ローテーションはサポートしていません。
手動ローテーションを行った場合は、新しく作成した公開鍵を利用者に配布する必要があります。

## 職務分掌
1人の個人が、悪意のある操作を行うのに必要なすべての権限を持たないようにすることを**職務分掌**と言います。
Google Cloudの公式ドキュメントでは、Cloud KMSを管理するうえで以下の方針を推しています。
- Cloud KMS専用のプロジェクトを作成し、基本ロールの**ownerを付与しない**
- 代わりに組織管理者が**鍵のIAM権限を管理する**
    - 組織管理者は鍵の管理や、使用はできないが鍵の管理や使用ができるユーザを制限するIAMポリシーの設定が可能。


## 鍵の目的とアルゴリズム
鍵を作成するときの項目として、**目的とアルゴリズム**があります。
目的は、


| 目的 | 説明 | 用途 |
| ---- | ---- | ---- |
| 対象暗号化/復号化 | 特定の時刻を測定するための指標 | CPU使用率 |
| raw対象暗号化/復号 | 時間間隔の変化を測定するための指標 | リクエスト数 |
| 非対称な署名 | 累積指標を測定するための指標 | ネットワーク送信・受信バイト数 |
| 非対称な復号化 | 累積指標を測定するための指標 | ネットワーク送信・受信バイト数 |
| MACの署名/検証 | 累積指標を測定するための指標 | ネットワーク送信・受信バイト数 |

## エンベロープ暗号化
エンベロープ暗号化とは、鍵を別の鍵で暗号化することを言います。
**データ暗号鍵(DEK)**がデータ自体を暗号化するために使用される鍵で、そのデータ暗号鍵を暗号化するために使用される鍵は**鍵暗号鍵(KEK)**と言います。

# Cloud HSMとは
Cloud HSMとは、**FIPS 140-2 レベル3認定ハードウェアセキュリティモジュール (HSM)**で暗号鍵のホスティングや、暗号化オペレーションを実行できるサービスです。
Cloud KMSと同様にフルマネージドでGoogle Cloud側が管理しているため、ユーザ側でHSM鍵を管理する必要はありません。
Cloud HSMを利用する場合は、CMEKを利用する場合と比べて、コストが高額になります。

Cloud HSMのアーキテクチャの詳細は、こちらをご覧ください
https://cloud.google.com/docs/security/cloud-hsm-architecture?hl=ja

# Cloud EKM
Cloud EKMは、**サードパーティー製の鍵管理パートナー**内で管理する鍵を使用して、Google Cloud内のデータを保護することができるサービスです。
Cloud EKMを利用することで、以下のような利点があります。
- 鍵の来歴
    - 外部管理する鍵の場所と分布を制御することができます。
- アクセス制御
    - 外部鍵マネージャーで外部管理鍵へのアクセスを管理します。Google Cloudプロジェクトに外部鍵マネージャーの鍵へのアクセス権を付与する必要がある。
- 一元化された鍵管理
    - 鍵とアクセスポリシーを1つのUIから管理することができます。

サポートされている外部鍵マネージャーは以下になります。
- Fortanix
- Futurex
- Thales
- Virtru

# CMEKを利用したデータ暗号化/復号化
キーリングを作成します。
```
gcloud kms keyrings create test-keyring \
 --location asia-northeast1 \
 --project="${GOOGLE_CLOUD_PROJECT}"
```

キーを作成します。
```
gcloud kms keys create encryption-key \
 --keyring test-keyring \
 --location asia-northeast1 \
 --purpose "encryption" \
 --protection-level "software"
```

```txt:test.txt
こんにちは。ぼくドラえもん。
```


```
gcloud kms encrypt \
 --key encryption-key \
 --keyring test-keyring \
 --location asia-northeast1 \
 --plaintext-file test.txt \
 --ciphertext-file test.txt.enc
```

```
$)Bs{Ḙ vOd^fB銕ܝUFHMlLEm\T2:  ^Ugߪ]|boZ{{=li4<s5?6"4ݒ
```

```
gcloud kms decrypt \
 --key encryption-key \
 --keyring test-keyring \
 --location asia-northeast1 \
 --ciphertext-file test.txt.enc \
 --plaintext-file test.txt
```

```txt:test.txt
こんにちは。ぼくドラえもん。
```